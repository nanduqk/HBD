define("zen.rt.components.filterbar/resources/js/filterbar_handler",["sap/zen/basehandler","zen.rt.components.filterpanel/resources/js/filterpanel_m_handler","css!../css/component.css"],function(BaseHandler,fph,css){var FilterBarHandler=function(){BaseHandler.apply(this,arguments);var dispatcher=BaseHandler.dispatcher;var me=this;function init(oControl,oControlProperties){var aChildren=oControlProperties.content;if(oControlProperties.content.length===0){oControl.removeAllFilters();oControl.removeAllFilterGroupItems();oControl.fireFilterChange();}if(aChildren.length>0){if(aChildren[0].component.content&&aChildren[0].component.content.control.newds){oControl.removeAllFilters();oControl.custProp.allChildrenSubmit=oControlProperties.allChildrenSubmit;}me.updateChildren(aChildren,oControl,function(oNewControl,iIndex,componentData){var filterGroupItem=new sap.ui.comp.filterbar.FilterGroupItem(oControl.getId()+"-"+oNewControl.getId(),{name:oControl.getId()+"-"+oNewControl.getId(),visibleInFilterBar:false,partOfCurrentVariant:true});filterGroupItem.setControl(oNewControl);filterGroupItem.setGroupName(sap.ui.comp.filterbar.FilterBar.INTERNAL_GROUP);if(componentData&&componentData.content&&componentData.content.control&&componentData.content.control.characteristics&&componentData.content.control.characteristics.length>0){filterGroupItem.setLabel(componentData.content.control.characteristics[0].characteristic.text);}else{if(oControlProperties.content[iIndex].component.content.control.characteristics&&oControlProperties.content[iIndex].component.content.control.characteristics.length>0){filterGroupItem.setLabel(oControlProperties.content[iIndex].component.content.control.characteristics[0].characteristic.text);}}filterGroupItem.setLabelTooltip(filterGroupItem.getLabel());oNewControl.addStyleClass("zenFilterBarMFilter");if(oNewControl.ZEN_multiInput&&oNewControl.ZEN_multiInput[0]){oNewControl.ZEN_multiInput[0].attachTokenChange(function(oEvent){oControl.fireFilterChange(oEvent);});}oControl.addFilterGroupItem(filterGroupItem);});oControl.fireFilterChange();}if(!oControl.custProp.showOnlyDimensionsWithFilter&&oControlProperties.visibleDimensionNames){var i,oDimFilter,oFilter,sDimName;var aFilters=oControl.getFilterGroupItems();var aVisibleDimensions=JSON.parse(oControlProperties.visibleDimensionNames);for(i=0;i<aFilters.length;i++){oFilter=aFilters[i];oDimFilter=oControl.determineControlByFilterItem(oFilter);if(oDimFilter){oFilter.setVisibleInFilterBar(false);sDimName=oDimFilter.getModel().getProperty("/characteristics/0/characteristic/name");for(var j=0;j<aVisibleDimensions.length;j++){if(sDimName===aVisibleDimensions[j]){oFilter.setVisibleInFilterBar(true);break;}}}}}}function refreshFilterVisibility(filterBar){if(filterBar.getFilterBarExpanded()){filterBar.removeStyleClass("zenFilterBarCompressed");var fixedWidth=false;if(getSampleDFWidth()==-1&&me.sampleDimensionFilterWidth(filterBar)==-1){fixedWidth=true;setSampleDFWidth(208);}me.refreshCollapseVisibleDFCount(filterBar);me.updateCustomExpandVisibility(filterBar);if(fixedWidth){setSampleDFWidth(undefined);}}else{filterBar.addStyleClass("zenFilterBarCompressed");}}me.create=function(oChainedControl,oControlProperties,oComponentProperties){var id=oControlProperties.id;jQuery.sap.require("sap.ui.comp.filterbar.FilterBar");var filterBar=new sap.ui.comp.filterbar.FilterBar(id,{advancedMode:false,considerGroupTitle:false,showRestoreButton:false,filterBarExpanded:oControlProperties.expanded}).addStyleClass("zenFilterBarM");if(!(sap.zen.designmode&&sap.zen.designmode.isDesignMode(oControlProperties.id))&&!oControlProperties.fbVisible){filterBar.toggleStyleClass("zenFilterBarMHidden");}filterBar.registerGetFiltersWithValues(function(){var i,oControl,aFilters=this.getFilterGroupItems(),aFiltersWithValue=[],oFilter,oFilterModel,sDimName,bNotChange,bDirty=false,oGoButton;for(i=0;i<aFilters.length;i++){oFilter=aFilters[i];oControl=this.determineControlByFilterItem(oFilter);oFilterModel=oControl.getModel().getProperty("/filters");sDimName=oControl.getModel().getProperty("/characteristics/0/characteristic/name");if(oControl&&oControl.ZEN_multiInput&&oControl.ZEN_multiInput[0]&&oFilterModel[sDimName].ranges.length){aFiltersWithValue.push(oFilter);if(filterBar.custProp.showOnlyDimensionsWithFilter){oFilter.setVisibleInFilterBar(true);}}else{if(filterBar.custProp.showOnlyDimensionsWithFilter){if(oFilterModel&&oFilterModel[sDimName]&&oFilterModel[sDimName].dirty){bNotChange=true;}if(!bNotChange){oFilter.setVisibleInFilterBar(false);}}}if(oFilterModel&&oFilterModel[sDimName]&&oFilterModel[sDimName].dirty){bDirty=true;}if(sap.zen.designmode&&!filterBar.custProp.showOnlyDimensionsWithFilter){oFilter.setVisibleInFilterBar(false);}}refreshFilterVisibility(filterBar);oGoButton=sap.ui.getCore().byId(this.getId()+"-btnGo");if(oGoButton){oGoButton.setEnabled(bDirty);}return aFiltersWithValue;});filterBar.custProp={};filterBar.custProp.i18n={expand:oControlProperties.EXPAND_ACTION,collapse:oControlProperties.COLLAPSE_ACTION};filterBar.custProp.allChildrenSubmit=oControlProperties.allChildrenSubmit;filterBar.custProp.showOnlyDimensionsWithFilter=oControlProperties.showfiltered;me.addCustomExpandButton(filterBar);init(filterBar,oControlProperties);filterBar.attachSearch(function(ev){me.handleSearch(ev,filterBar);});setCommand(filterBar,"EXPAND",oControlProperties.expandcmd);setCommand(filterBar,"CHANGE_VISIBLE_FILTERS",oControlProperties.visiblefilterscmd);filterBar.addEventDelegate({onAfterRendering:function(ev){ev.srcControl.removeEventDelegate(this);me.updateEnablement(ev.srcControl,oControlProperties);$(ev.srcControl.getParent().getDomRef()).addClass("zenFilterBarMParentCont");}});me.hideFilterDialogHeader(filterBar);me.initOverflowExpand(filterBar,oControlProperties);return filterBar;};me.update=function(oControl,oControlProperties,oComponentProperties){if(oControlProperties){oControl.orig_setFilterBarExpanded(oControlProperties.expanded);init(oControl,oControlProperties);me.updateVisibility(oControl,oControlProperties);me.updateEnablement(oControl,oControlProperties);if(sap.zen.designmode){oControl.custProp.showOnlyDimensionsWithFilter=oControlProperties.showfiltered;oControl._getFiltersWithValues();}}return oControl;};me.applyForChildren=function(oControl,funclet){var content=oControl.getAllFilterItems();for(var i=0;i<content.length;i++){var filterControl=oControl.determineControlByFilterItem(content[i]);if(filterControl){var result=funclet(filterControl);if(result){return result;}}}return null;};me.getType=function(){return"filterbar";};me.updateVisibility=function(filterBar,oControlProperties){if(oControlProperties.visibilityChanged){filterBar.toggleStyleClass("zenFilterBarMHidden");}};me.initOverflowExpand=function(filterBar,oControlProperties){dispatcher.registerResizeHandler(filterBar,{endResize:function(e){if(e){if(getSampleDFWidth()==-1){me.sampleDimensionFilterWidth(filterBar);}refreshFilterVisibility(filterBar);}}});filterBar.onAfterRendering=function(oEvent){if(!filterBar._bDoItOnce&&!(filterBar._isPhone()||filterBar._isTablet())){filterBar._bDoItOnce=true;}};filterBar.orig_setFilterBarExpanded=filterBar.setFilterBarExpanded;filterBar.setFilterBarExpanded=function(bShowExpanded){var bOldExpanded=this.getFilterBarExpanded();filterBar.orig_setFilterBarExpanded.call(filterBar,bShowExpanded);if(bShowExpanded!=bOldExpanded){if(!bShowExpanded){me.updateCustomExpandVisibility(filterBar);}var commandStr=getCommand(filterBar,"EXPAND");if(commandStr){eval(commandStr);}new Function(oControlProperties.onToggle).call();}};};me.addCustomExpandButton=function(filterBar){if(filterBar._oToolbar){var hideShowButtonIndex;if(filterBar._oHideShowButton){hideShowButtonIndex=filterBar._oToolbar.indexOfContent(filterBar._oHideShowButton);}if(hideShowButtonIndex){jQuery.sap.require("sap.m.Button");jQuery.sap.require("sap.m.ButtonType");filterBar.customExpandButton=new sap.m.Button({text:filterBar.custProp.i18n.expand,visible:false,type:sap.m.ButtonType.Transparent});filterBar.customExpandButton.attachPress(function(){me.toggleExpandOverlay(filterBar);});filterBar.customExpandButton.addStyleClass("zenCustomExpandButton");filterBar._oToolbar.insertContent(filterBar.customExpandButton,hideShowButtonIndex);}}};me.updateCustomExpandVisibility=function(filterBar){var expandButtonVisible=false;if(filterBar.getFilterBarExpanded()){expandButtonVisible=me.checkCustomExpandVisibility(filterBar)&&filterBar.getFilterBarExpanded();}filterBar.customExpandButton.setVisible(expandButtonVisible);if(filterBar.custProp.customExpanded&&!expandButtonVisible){me.toggleExpandOverlay(filterBar,true);}};me.refreshCollapseVisibleDFCount=function(filterBar){if(getSampleDFWidth()==-1){me.sampleDimensionFilterWidth(filterBar);}var count=Math.floor((($(filterBar.getDomRef()).width())/getSampleDFWidth()));var aFilters=filterBar.getFilterGroupItems();var indexVisible=0;for(var i=0;i<aFilters.length;i++){var oFilter=aFilters[i];if(oFilter.getVisibleInFilterBar()){var oDimFilter=filterBar.determineControlByFilterItem(oFilter);if(oDimFilter&&oDimFilter.getParent()&&oDimFilter.getParent().addStyleClass){if(indexVisible++>=count){oDimFilter.getParent().addStyleClass("zenFBIhidden");}else{oDimFilter.getParent().removeStyleClass("zenFBIhidden");}}}}};me.checkCustomExpandVisibility=function(filterBar){var retValue=false;var visibleDFCount=getVisibleDFCount(filterBar);if(getSampleDFWidth()!=-1){if((visibleDFCount*getSampleDFWidth())>($(filterBar.getDomRef()).width())){retValue=true;}}return retValue;};me.sampleDimensionFilterWidth=function(filterBar){var w=-1;var dfs=filterBar.getAllFilterItems();if(dfs.length>1){var df=$(filterBar.getDomRef()).find(".sapUiCompFilterBarBasicArea>div:first-of-type");if(df){var dfPaddings=parseInt(df.css("padding-left"),10)+parseInt(df.css("padding-right"),10);if(isNaN(dfPaddings)){dfPaddings=0;}if(df.width()!=null){w=df.width()+dfPaddings;}}}setSampleDFWidth(w);return w;};me.toggleExpandOverlay=function(filterBar,manualClose){if(filterBar.custProp.customExpanded||manualClose===true){filterBar.removeStyleClass("zenCustomExpand");filterBar.custProp.customExpanded=false;filterBar.customExpandButton.setText(filterBar.custProp.i18n.expand);}else{filterBar.addStyleClass("zenCustomExpand");filterBar.custProp.customExpanded=true;filterBar.customExpandButton.setText(filterBar.custProp.i18n.collapse);}};me.hideFilterDialogHeader=function(filterBar){me.originalShowFilterDialog=filterBar._showFilterDialog;filterBar._showFilterDialog=function(){$(document.body).addClass("zenFilterBarDialogOpened");me.applyForChildren(filterBar,function(oDimFilter){oDimFilter.ZENFilterBeforeDialog=JSON.stringify(oDimFilter.getModel().getProperty("/filters"));});me.originalShowFilterDialog.call(filterBar);if(filterBar.custProp.showOnlyDimensionsWithFilter){var n,i,oItem;for(n in filterBar._mAdvancedAreaFilter){if(n&&filterBar._mAdvancedAreaFilter[n].items){for(i=0;i<filterBar._mAdvancedAreaFilter[n].items.length;i++){oItem=filterBar._mAdvancedAreaFilter[n].items[i];if(oItem.checkbox){oItem.checkbox.setEnabled(false);}}}}}filterBar.attachFiltersDialogClosed(function(){me.applyForChildren(filterBar,function(oDimFilter){if(oDimFilter.ZENFilterBeforeDialog){oDimFilter.ZENFilterBeforeDialog=null;}});$(document.body).removeClass("zenFilterBarDialogOpened");refreshFilterVisibility(filterBar);});};me.originalCancelFilterDialog=filterBar._cancelFilterDialog;filterBar._cancelFilterDialog=function(){me.applyForChildren(filterBar,function(oDimFilter){if(oDimFilter.ZENFilterBeforeDialog){oDimFilter.getModel().setProperty("/filters",JSON.parse(oDimFilter.ZENFilterBeforeDialog));oDimFilter.ZENFilterBeforeDialog=null;}});me.originalCancelFilterDialog.call(filterBar);};};me.handleSearch=function(ev,filterBar){var i=0;var j=i;var submitCmd=filterBar.custProp.allChildrenSubmit;var iKeyWord=submitCmd.indexOf("__STRING____");var sScope=(filterBar.zenScope&&filterBar.zenScope.replace)?filterBar.zenScope.replace(".",""):"";while(iKeyWord>0){var keyWeNeedToReplace="";if(typeof(DSH_deployment)=="undefined"){keyWeNeedToReplace=submitCmd.substring(iKeyWord,submitCmd.indexOf("'",iKeyWord));}else{keyWeNeedToReplace=submitCmd.substring(iKeyWord,submitCmd.indexOf("\\x27",iKeyWord));}var idWeNeed=sScope+keyWeNeedToReplace.substring(12)+"_filter1";var oDimensionFilter=sap.ui.getCore().byId(idWeNeed);if(!oDimensionFilter){oDimensionFilter=sap.ui.getCore().byId(filterBar.zenScope+idWeNeed);}var oldSubmitMethod=submitCmd;submitCmd=oDimensionFilter.ZEN_submit(keyWeNeedToReplace,submitCmd);if(!submitCmd){submitCmd=oldSubmitMethod.replace(keyWeNeedToReplace,"{}");}iKeyWord=submitCmd.indexOf("__STRING____");}if(!filterBar.custProp.showOnlyDimensionsWithFilter){var sVisibleDimensions=me.getVisibleDimensions(filterBar);var visibleFiltersChangedCmd=getCommand(filterBar,"CHANGE_VISIBLE_FILTERS");if(visibleFiltersChangedCmd&&sVisibleDimensions&&visibleFiltersChangedCmd.indexOf("__arg1__")>=0){visibleFiltersChangedCmd=visibleFiltersChangedCmd.replace("__arg1__",sVisibleDimensions);new Function(visibleFiltersChangedCmd)();}}filterBar.custProp.suppressSetSaveScenario=true;if(submitCmd){new Function(submitCmd)();}};me.getVisibleDimensions=function(filterBar){var i,oControl,oFilter,sDimName;var aFilters=filterBar.getFilterGroupItems();var aVisibleDimensions=[];for(i=0;i<aFilters.length;i++){oFilter=aFilters[i];if(oFilter.getVisibleInFilterBar()){oControl=filterBar.determineControlByFilterItem(oFilter);if(oControl){sDimName=oControl.getModel().getProperty("/characteristics/0/characteristic/name");if(sDimName){aVisibleDimensions.push(sDimName);}}}}return JSON.stringify(aVisibleDimensions);};me.updateEnablement=function(filterBar,oControlProperties){var enableState=oControlProperties.datasource!=null&&oControlProperties.datasource!=""&&oControlProperties.enabled;if(oControlProperties.hasOwnProperty("enabled")){var toolbarButtons=$(filterBar.getDomRef()).find(".sapUiCompFilterBarToolbar>button");for(var i=0;i<toolbarButtons.length;i++){var btn=sap.ui.getCore().byId(toolbarButtons[i].id);if(btn){if(toolbarButtons[i].id.indexOf("btnGo")>0&&enableState){filterBar.fireFilterChange();}else{btn.setEnabled(enableState);}}}var dimensionFilters=$(filterBar.getDomRef()).find(".sapzenfilterpanelM .sapMInput");for(var i=0;i<dimensionFilters.length;i++){var input=sap.ui.getCore().byId(dimensionFilters[i].id);if(input){input.setEnabled(enableState);}}}};function getVisibleDFCount(filterBar){var dfs=filterBar.getAllFilterItems(true);var visibleDFCount=0;for(var i=0;dfs&&i<dfs.length;i++){if(dfs[i].getVisibleInFilterBar()){visibleDFCount++;}}return visibleDFCount;}function setSampleDFWidth(val){me._sampleDFWidth=val;}function getSampleDFWidth(val){if(!me._sampleDFWidth){me._sampleDFWidth=-1;}return me._sampleDFWidth;}function getCommand(oControl,type){var c;if(oControl.custProp&&oControl.custProp.commands){c=oControl.custProp.commands[type];}return c;}function setCommand(oControl,type,command){if(oControl.custProp){if(!oControl.custProp.commands){oControl.custProp.commands={};}oControl.custProp.commands[type]=command;}}this.getDecorator=function(){return"DataSourceFixedHeightDecorator";};};return new FilterBarHandler();});