/*
ï¿½2010 - 2016 SAP SE or an SAP affiliate company.  All rights reserved.
 
SAP and other SAP products and services mentioned herein as well as their respective logos are trademarks or registered trademarks of SAP SE in Germany and other countries.  Please see http://www.sap.com/corporate-en/legal/copyright/index.epx#trademark for additional trademark information and notices.
*/

jQuery.sap.declare({modName:"com.sap.fioribi.modules.logonpage.LogonpageController",type:"controller"});jQuery.sap.require({modName:"com.sap.fioribi.modules.common.BILPController",type:"controller"});jQuery.sap.require("com.sap.fioribi.utils.RequestDispatcher");com.sap.fioribi.modules.logonpage.LogonpageController=function(){if(!$("html").hasClass("sapUiTheme-sap_belize")){sap.ui.getCore().applyTheme("sap_belize");}com.sap.fioribi.modules.common.BILPController.apply(this,arguments);};com.sap.fioribi.modules.logonpage.LogonpageController.prototype=jQuery.sap.newObject(com.sap.fioribi.modules.common.BILPController.prototype);com.sap.fioribi.modules.logonpage.LogonpageController.prototype.onInit=function(){};com.sap.fioribi.modules.logonpage.LogonpageController.prototype.onAfterRendering=function(){jQuery.sap.require("com.sap.fioribi.widgets.CanvasShapesManager");$(".BILP-launchpadbackground>section").before('<canvas id="shell-shapes" width='+$(window).width()+" height="+$(window).height()+' style="position: absolute;"></canvas>');this.redrawBackGroundShapes();sap.ui.getCore().attachThemeChanged(this.redrawBackGroundShapes);};com.sap.fioribi.modules.logonpage.LogonpageController.prototype.redrawBackGroundShapes=function(){com.sap.fioribi.widgets.CanvasShapesManager.drawShapes();};com.sap.fioribi.modules.logonpage.LogonpageController.prototype.loadLaunchpadApp=function(data){jQuery.sap.require("com.sap.fioribi.app.BILaunchpadApp");var appSettings={logonToken:data.logontoken,webServiceURL:data.sRestWebServiceURL,pvl:sPVL,productLocale:sProductLocale};var oCore=sap.ui.getCore();oCore.attachInit(function(){BILaunchpadApp.init(appSettings);});};com.sap.fioribi.modules.logonpage.LogonpageController.prototype.initSettings=function(){this.initLocaleAndTimeZones();this.initPagePreferences();};com.sap.fioribi.modules.logonpage.LogonpageController.prototype.initLocaleAndTimeZones=function(){var reqDispatcher=new RequestDispatcher();var setLocale=function(jsonData){var browserLocale=BILaunchpadApp.oBILaunchpadUtil.getBrowserLocale();if(jsonData.documentlocale==""){BILaunchpadApp.setPreferredViewingLocale(jsonData.documentlocale);}else{BILaunchpadApp.setPreferredViewingLocale(browserLocale);}if(jsonData.productlocale==""){BILaunchpadApp.setProductLocale(jsonData.productlocale);}else{BILaunchpadApp.setProductLocale(browserLocale);}BILaunchpadApp.setTimeZone(jsonData.timezone);};var localeError=function(xhr,ajaxOptions,thrownError){console.log("Unable to get locale information hence using browser locale");};var request={surl:BILaunchpadApp.getWebServiceBaseURL()+"/internal/v1/settings/userpreferences/localeandtimezone",reqType:"GET",successHandler:setLocale,errorHandler:localeError,headers:{Accept:"application/json","Content-Type":"application/json;odata=verbose","x-sap-logontoken":BILaunchpadApp.getlogonToken()}};reqDispatcher.sendRequest(request);};com.sap.fioribi.modules.logonpage.LogonpageController.prototype.initPagePreferences=function(){var reqDispatcher=new RequestDispatcher();var setPagePreference=function(jsonData){BILaunchpadApp.setHomePageTab(jsonData.landingpageoption);BILaunchpadApp.setListingType(jsonData.listdocumentas);};var errorPagePreference=function(xhr,ajaxOptions,thrownError){console.log("error");};var request={surl:BILaunchpadApp.getWebServiceBaseURL()+"/internal/v1/settings/userpreferences/pagepreferences",reqType:"GET",successHandler:setPagePreference,errorHandler:errorPagePreference,headers:{Accept:"application/json","Content-Type":"application/json;odata=verbose","x-sap-logontoken":BILaunchpadApp.getlogonToken()}};reqDispatcher.sendRequest(request);};com.sap.fioribi.modules.logonpage.LogonpageController.prototype.logonToBI=function(data){var PROTOCOL="http://";var PORT=":6405";var BASEAPI="/biprws";var LOGONAPI="/v1/logon/long";var HOST=data.system.trim();if(!HOST.length>0){HOST="CMS";}var RESTURL=PROTOCOL+HOST+PORT+BASEAPI;var LOGONURL=RESTURL+LOGONAPI;var fnLogonSuccess=function(data){this.loadLaunchpadApp(data);this.getView().destroyContent();};var fnLogonFailure=function(err){jQuery.sap.require("sap.m.MessageBox");if(err.lenght>0){sap.m.MessageBox.error(err);}else{sap.m.MessageBox.error("Logon Failed");}};var oHandler={success:$.proxy(fnLogonSuccess,this),error:$.proxy(fnLogonFailure,this)};var credentials=data.credentials;credentials.clienttype="bing Launchpad";try{$.ajax({cache:false,url:LOGONURL,type:"POST",data:JSON.stringify(credentials),headers:{Accept:"application/json","Content-Type":"application/json;odata=verbose"},success:function(data,textStatus,xhr){var fnSuccess=oHandler.success;data.sRestWebServiceURL=RESTURL;fnSuccess(data);},error:function(xhr,textStatus,thrownError){var fnLogonFailure=oHandler.error;fnLogonFailure(thrownError);}});}catch(exception){fnLogonFailure(thrownError);}};