define("zen.rt.components.popup/resources/js/popupm_handler",["sap/zen/basehandler","css!../css/component.css"],function(BaseHandler){var PopupmHandler=function(){jQuery.sap.require("sap.ui.core.Popup");jQuery.sap.require("sap.m.Panel");jQuery.sap.require("sap.m.BackgroundDesign");var me=this;BaseHandler.apply(me,arguments);var dispatcher=BaseHandler.dispatcher;function init(oProxy,oControlProperties){var oPanel=oProxy.zenPanel;var aChildren=oControlProperties.content;var oAbsLayout=oPanel.getContent()[0];if(aChildren){me.updateChildren(aChildren,oProxy,function(oNewControl,iIndex){dispatcher.insertIntoAbsoluteLayoutContainer(oAbsLayout,oNewControl,iIndex);},function(oControlToDelete){oAbsLayout.removeContent(oControlToDelete);$(oPanel.getDomRef()).focus();});}}this.applyForChildren=function(oProxy,fFunclet){var oPanel=oProxy.zenPanel;var absLayout=oPanel.getContent()[0];var children=absLayout.getContent();for(var i=0;i<children.length;i++){var oControl=children[i];if(oControl){fFunclet(oControl);}}};me.getDecorator=function(){return"PopupDecorator";};me.getType=function(){return"popup";};me.createAndAdd=function(oChainedControl,oControlProperties,oComponentProperties,fAppendToParentFunclet,iIndex){var panel=new sap.m.Panel(oControlProperties.id,{content:[this.createAbsoluteLayout(oControlProperties.id+"_abs")]}).addStyleClass("zenmpopup");var fSolveBug=function(){if(panel&&panel.$().length>0&&panel.$().children(".sapMPanelContent").length===1&&panel.getHeight()==="auto"){panel.$().children(".sapMPanelContent").css("height","100%");}};var fOld_setContentHeight=panel._setContentHeight;panel._setContentHeight=function(){fOld_setContentHeight.apply(this,arguments);fSolveBug();};var oProxy;if(sap.zen.designmode&&sap.zen.designmode.isDesignMode(oControlProperties.id)){panel.addStyleClass("zenborder");oProxy=panel;oProxy.zenPanel=panel;}else{oProxy=this.createAbsoluteLayout(oControlProperties.id+"_proxy");var fOldAddStyleClass=oProxy.addStyleClass;oProxy.addStyleClass=function(sClasses){fOldAddStyleClass.apply(this,arguments);panel.addStyleClass(sClasses);};var fOldRemoveStyleClass=oProxy.removeStyleClass;oProxy.removeStyleClass=function(sClasses){fOldRemoveStyleClass.apply(this,arguments);panel.removeStyleClass(sClasses);};oProxy.zenPanel=panel;var fOldDestroy=oProxy.destroy;oProxy.destroy=function(){if(panel.zenPopup){panel.zenPopup.detachClosed(panel.zenPopup.zenClosedFunction);panel.zenPopup.close();me.cleanUp(oProxy);}panel.destroy();fOldDestroy.apply(this,arguments);};}fAppendToParentFunclet(oProxy,iIndex);sap.zen.Dispatcher.instance.updateComponentProperties(oProxy,oComponentProperties);sap.zen.Dispatcher.instance.updateComponentProperties(panel,oComponentProperties);init(oProxy,oControlProperties);me.updatePanelBg(panel,oControlProperties);if(!(sap.zen.designmode&&sap.zen.designmode.isDesignMode(oControlProperties.id))){oProxy.setWidth("0px");oProxy.setHeight("0px");oProxy.addEventDelegate({onAfterRendering:function(ev){ev.srcControl.removeEventDelegate(this);ev.srcControl.setVisible(false);ev.srcControl.zenPanel.setVisible(false);me.renderPopup(oProxy,oControlProperties,oComponentProperties);}});var fOnVarDialogOpen=function(){if(oProxy&&oProxy.zenPanel&&oProxy.zenPanel.zenPopup&&oProxy.zenPanel.zenPopup.isOpen()&&oProxy.zenPanel.zenPopup.getAutoClose()){oProxy.zenPanel.zenPopup.setAutoClose(false);oProxy.zenPanel.zenPopup.zenHadAutoClose=true;}};var fOnVarDialogClose=function(){if(oProxy&&oProxy.zenPanel&&oProxy.zenPanel.zenPopup&&oProxy.zenPanel.zenPopup.isOpen()&&oProxy.zenPanel.zenPopup.zenHadAutoClose){oProxy.zenPanel.zenPopup.setAutoClose(true);if(panel&&panel.$().length>0){$(panel.$()).focus();}delete oProxy.zenPanel.zenPopup.zenHadAutoClose;}};oProxy.zenFOnVarDialogOpen=fOnVarDialogOpen;oProxy.zenFOnVarDialogClose=fOnVarDialogClose;dispatcher.registerControlNotifyVariableDialog(oProxy.zenFOnVarDialogOpen,oProxy.zenFOnVarDialogClose);}return oProxy;};var super_remove=this.remove;me.remove=function(oControl){super_remove.call(this,oControl);dispatcher.unregisterControlNotifyVariableDialog(oControl.zenFOnVarDialogOpen,oControl.zenFOnVarDialogClose);};me.update=function(oProxy,oControlProperties,oComponentProperties){oControlProperties=oControlProperties||{};var panel=oProxy.zenPanel;init(oProxy,oControlProperties);me.updatePanelBg(panel,oControlProperties);me.renderPopup(oProxy,oControlProperties,oComponentProperties);return oProxy;};me.renderPopup=function(oProxy,oControlProperties,oComponentProperties){var popup=oProxy.zenPanel.zenPopup;if(!(sap.zen.designmode&&sap.zen.designmode.isDesignMode(oControlProperties.id))){if(oControlProperties.show===false){me.hide(oProxy,oControlProperties);}else{if(oControlProperties.show===true||(popup&&popup.isOpen())){me.show(oProxy,oControlProperties,oComponentProperties);}}}};me.updatePanelBg=function(oPanel,oControlProperties){if(oPanel&&oControlProperties.backgroundDesign){if(oControlProperties.backgroundDesign=="TRANSPARENT"){oPanel.setBackgroundDesign(sap.m.BackgroundDesign.Transparent);}else{if(oControlProperties.backgroundDesign=="SOLID"){oPanel.setBackgroundDesign(sap.m.BackgroundDesign.Solid);}else{if(oControlProperties.backgroundDesign=="TRANSLUCENT"){oPanel.setBackgroundDesign(sap.m.BackgroundDesign.Translucent);}}}}};me.show=function(oProxy,oControlProperties,oComponentProperties){var oPanel=oProxy.zenPanel;var popup=oPanel.zenPopup;var update=true;if(!popup){update=false;popup=me.createPopup(oProxy,oControlProperties);if(oControlProperties.openCentered){me.repositionPopup(popup);popup.zenOpenCentered=true;}popup.getContent().toggleStyleClass("autoHeight",isAuto(oComponentProperties.height));popup.getContent().toggleStyleClass("autoWidth",isAuto(oComponentProperties.width));me.addAutoCloseDispatchTracking(popup,oPanel);popup.open();}if(!oControlProperties.openCentered&&!popup.zenOpenCentered){var args=sap.zen.Dispatcher.instance.createAbsoluteLayoutInfo(oComponentProperties);var width=sap.zen.Dispatcher.instance.calcWidthUseOrderOfPriority(args.left,args.right,oComponentProperties.width);var height=sap.zen.Dispatcher.instance.calcHeightUseOrderOfPriority(args.top,args.bottom,oComponentProperties.height);sap.zen.Dispatcher.instance.setWidthHeight(oPanel,width,height);if(!update){popup.getContent().toggleStyleClass("autoHeight",isAuto(oComponentProperties.height));popup.getContent().toggleStyleClass("autoWidth",isAuto(oComponentProperties.width));}$(oPanel.getDomRef()).css(args);}};me.popupOpened=function(ev){var popupContent=ev.oSource.getContent();if(popupContent){$(popupContent.getDomRef()).attr("tabindex",0);if(ev.oSource.getAutoClose()){$(popupContent.getDomRef()).focus();}}};me.resizeHandler=function(){var popups=getOpenCenterPopups();for(var p in popups){me.repositionPopup(popups[p]);}};me.repositionPopup=function(popup){if(popup){popup.setPosition("center center","center center",window,"0 0","fit");}};me.hide=function(oProxy,oControlProperties){var oPanel=oProxy.zenPanel;var popup=oPanel.zenPopup;if(popup&&popup.isOpen()){popup.detachClosed(popup.zenClosedFunction);popup.close(0);me.cleanUp(oProxy);}};me.createPopup=function(oProxy,oControlProperties){var oPanel=oProxy.zenPanel;var autoclose=oControlProperties.autoclose;if(oControlProperties.modal){autoclose=false;}oPanel.setVisible(true);var popup=new sap.ui.core.Popup(oPanel,!!oControlProperties.modal,true,!!autoclose);popup.zenClosedFunction=function(){me.handlePopupClosed(oProxy,oControlProperties);};popup.attachClosed(popup.zenClosedFunction);popup.attachOpened(me.popupOpened);if(oControlProperties.openCentered){sap.zen.Dispatcher.instance.registerResizeHandler(oProxy,{endResize:function(e){if(e){me.repositionPopup(oProxy.zenPanel.zenPopup);}}});}oPanel.zenPopup=popup;return popup;};me.handlePopupClosed=function(oProxy,oControlProperties){var commandStr=oControlProperties.command;if(commandStr){var command=me.prepareCommand(commandStr,"__VALUE__","false");eval(command);}me.cleanUp(oProxy);};me.cleanUp=function(oProxy){var panel=oProxy.zenPanel;var popup=panel.zenPopup;if(popup){sap.zen.Dispatcher.instance.untrackAutoClosePopup(popup);sap.zen.Dispatcher.instance.deregisterResizeHandler(oProxy);popup.destroy();panel.zenPopup=null;}};me.addAutoCloseDispatchTracking=function(oPopUp,oPanel){if(oPopUp&&oPopUp.getAutoClose()){var fnFocusCallback=function(){if(oPanel&&!oPanel.getDomRef().contains(document.activeElement)){$(oPanel.getDomRef()).focus();}};sap.zen.Dispatcher.instance.trackAutoClosePopup(oPopUp,fnFocusCallback);}};function isAuto(sProperty){return sProperty===undefined||sProperty==="auto";}};var handler=new PopupmHandler();return handler;});