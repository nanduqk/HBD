/*
ï¿½2010 - 2016 SAP SE or an SAP affiliate company.  All rights reserved.
 
SAP and other SAP products and services mentioned herein as well as their respective logos are trademarks or registered trademarks of SAP SE in Germany and other countries.  Please see http://www.sap.com/corporate-en/legal/copyright/index.epx#trademark for additional trademark information and notices.
*/

jQuery.sap.declare({modName:"com.sap.fioribi.modules.homepage.HomepageController",type:"controller"});jQuery.sap.require({modName:"com.sap.fioribi.modules.common.BILPController",type:"controller"});jQuery.sap.declare({modName:"com.sap.fioribi.modules.homepage.HomepageController",type:"controller"});jQuery.sap.require({modName:"com.sap.fioribi.modules.common.BILPController",type:"controller"});jQuery.sap.require("sap.ui.core.dnd.DragInfo");jQuery.sap.require("sap.f.dnd.GridDropInfo");jQuery.sap.require("sap.ui.core.dnd.DropPosition");jQuery.sap.require("sap.ui.core.dnd.DropLayout");com.sap.fioribi.modules.homepage.HomepageController=function(){if(!$("html").hasClass("sapUiTheme-sap_belize")){sap.ui.getCore().applyTheme("sap_belize");}com.sap.fioribi.modules.common.BILPController.apply(this,arguments);};com.sap.fioribi.modules.homepage.HomepageController.prototype=jQuery.sap.newObject(com.sap.fioribi.modules.common.BILPController.prototype);com.sap.fioribi.modules.homepage.HomepageController.prototype.onInit=function(){BILaunchpadApp.includeStyleSheet("com/sap/fioribi/css/BiWorkspace.css");sap.ui.core.IconPool.addIcon("cr","customfont","bi-iconsregular","E806");sap.ui.core.IconPool.addIcon("webi","customfont","bi-iconsregular","E81C");sap.ui.core.IconPool.addIcon("lumira","customfont","bi-iconsregular","E80C");sap.ui.core.IconPool.addIcon("pdf","customfont","bi-iconsregular","E817");sap.ui.core.IconPool.addIcon("txt","customfont","bi-iconsregular","E80D");sap.ui.core.IconPool.addIcon("contentLink","customfont","bi-iconsregular","E812");var B={fontFamily:"BusinessSuiteInAppSymbols",fontURI:sap.ui.require.toUrl("sap/ushell/themes/base/fonts/")};var b=[];var c={};sap.ui.core.IconPool.registerFont(B);b.push(sap.ui.core.IconPool.fontLoaded("BusinessSuiteInAppSymbols"));c.BusinessSuiteInAppSymbols=B;var currentController=this;this.executedStatus=true;var reqDispatcher=new RequestDispatcher();var successUserName=function(response){if(response.accountname!=undefined){if(response.fullname!=""&&response.fullname!=undefined){sap.ui.getCore().setModel(response.fullname,"username");}else{sap.ui.getCore().setModel(response.accountname,"username");}}sap.ui.getCore().setModel(response,"myInfoCount");com.sap.fioribi.modules.homepage.HomepageView.prototype.createAvatarInitial();};var errorUserName=function(xhr,ajaxOptions,thrownError){var clsBtn=new sap.m.Button({text:BILaunchpadApp.localized("Recycle_Bin_Close"),press:$.proxy(function(){errDialog.close();},this)});var errDialog=new sap.m.Dialog().addButton(clsBtn);errDialog.open();errDialog.setTitle(BILaunchpadApp.localized("Error"));BILaunchpadApp.oErrorHandler.showErrorMessage(xhr,errDialog);};var request={surl:BILaunchpadApp.getWebServiceBaseURL()+"/internal/v1/settings/myinfo",reqType:"GET",bAsync:false,successHandler:successUserName,errorHandler:errorUserName,headers:{Accept:"application/json","Content-Type":"application/json;odata=verbose","x-sap-logontoken":BILaunchpadApp.getlogonToken()}};if(sap.ui.getCore().getModel("username")==undefined){reqDispatcher.sendRequest(request);}else{com.sap.fioribi.modules.homepage.HomepageView.prototype.createAvatarInitial();}var setVersion=function(response){if(response!=null&&response.build!=undefined){var buildInfo=response.build.split(".");var BOEVersion=parseInt(buildInfo[0])%10;BOEVersion+="."+buildInfo[1]+"."+buildInfo[2];BILaunchpadApp.setBOEVersion(BOEVersion);}};var versionReqDispatcher=new RequestDispatcher();versionReqDispatcher.sendRequest({surl:BILaunchpadApp.getWebServiceBaseURL()+"/v1/about",reqType:"GET",successHandler:setVersion,headers:{Accept:"application/json","Content-Type":"application/json;odata=verbose","x-SAP-logonToken":BILaunchpadApp.getlogonToken(),}});};com.sap.fioribi.modules.homepage.HomepageController.prototype.saveColumnResizePreferences=function(){var currentController=this;var pagePrefModel=sap.ui.getCore().getModel("pagePrefModel");var homePagePrefModel=sap.ui.getCore().getModel("homePagePrefModel");var localePagePrefModel=sap.ui.getCore().getModel("localePagePrefModel");var columnPxModel=sap.ui.getCore().getModel("columnWidth").getData();if(Object.keys(sap.ui.getCore().getModel("columnWidth").getData())=="columns"){var treeTablecolumnPxModel=sap.ui.getCore().getModel("columnWidth").getData();for(var i=0;i<treeTablecolumnPxModel.columns.length;i++){var treeTabledKey=treeTablecolumnPxModel.columns[i].columnId;var columnNameAsPerPrefModel=this.getColumnNameAsPerPreferenceModel(treeTabledKey)+"_width";pagePrefModel[columnNameAsPerPrefModel]=treeTablecolumnPxModel.columns[i].width;}}else{for(var key in columnPxModel){var updatedKey=key+"_width";pagePrefModel[updatedKey]=columnPxModel[key];}}for(var key in homePagePrefModel){pagePrefModel[key]=homePagePrefModel[key];}for(var key in localePagePrefModel){pagePrefModel[key]=localePagePrefModel[key];}var successColumnResizePreferences=function(response){sap.ui.getCore().setModel(response,"pagePrefModel");sap.ui.getCore().getModel("columnWidth").destroy();};var errorColumnResizePreferences=function(xhr,ajaxOptions,thrownError){sap.ui.getCore().getModel("columnWidth").destroy();};var requestColumnResizePreferences={surl:BILaunchpadApp.getWebServiceBaseURL()+"/internal/v1/settings/userpreferences/preference",reqType:"POST",successHandler:successColumnResizePreferences,errorHandler:errorColumnResizePreferences,data:JSON.stringify(pagePrefModel),headers:{Accept:"application/json","Content-Type":"application/json;odata=verbose","x-sap-logontoken":BILaunchpadApp.getlogonToken()}};requestColumnResizePreferences.bAsync=false;var reqDispatcher=new RequestDispatcher();reqDispatcher.sendRequest(requestColumnResizePreferences);};com.sap.fioribi.modules.homepage.HomepageController.prototype.getUserMessage=function(){var currentController=this;var reqDispatcher=new RequestDispatcher();var bdisclaimerFlag=true;try{var getDisclaimer=findCallback("callbackGetDisclaimerProp");bdisclaimerFlag=$.trim(getDisclaimer());}catch(exp){bdisclaimerFlag=true;}var successUserMessage=function(response){if(response.disclaimer!=undefined){if(bdisclaimerFlag.toLowerCase()!="false"&&response.disclaimer=="0"){currentController.getView().disclaimerDialog.open();}}};var errorUserMessage=function(xhr,ajaxOptions,thrownError){var clsBtn=new sap.m.Button({text:BILaunchpadApp.localized("Recycle_Bin_Close"),press:$.proxy(function(){errDialog.close();},this)});var errDialog=new sap.m.Dialog().addButton(clsBtn);errDialog.open();errDialog.setTitle(BILaunchpadApp.localized("Error"));BILaunchpadApp.oErrorHandler.showErrorMessage(xhr,errDialog);};var request={surl:BILaunchpadApp.getWebServiceBaseURL()+"/internal/v1/user/disclaimer/Ac7UIwmYafpFuhiiw6FRXLQ",reqType:"GET",successHandler:successUserMessage,errorHandler:errorUserMessage,headers:{Accept:"application/json","Content-Type":"application/json;odata=verbose","x-sap-logontoken":BILaunchpadApp.getlogonToken()}};var allSettingsModel=sap.ui.getCore().getModel("allSettingsModel");if(!allSettingsModel){reqDispatcher.sendRequest(request);}else{successUserMessage(allSettingsModel.oData.entries[2]);}};com.sap.fioribi.modules.homepage.HomepageController.prototype.updateUserMessage=function(){var reqDispatcher=new RequestDispatcher();var createError=function(xhr,ajaxOptions,thrownError){var clsBtn=new sap.m.Button({text:BILaunchpadApp.localized("Recycle_Bin_Close"),press:$.proxy(function(){errDialog.close();},this)});var errDialog=new sap.m.Dialog().addButton(clsBtn);errDialog.open();errDialog.setTitle(BILaunchpadApp.localized("Error"));BILaunchpadApp.oErrorHandler.showErrorMessage(xhr,errDialog);};var createSuccess=function(response){};var request={surl:BILaunchpadApp.getWebServiceBaseURL()+"/internal/v1/user/disclaimer/Ac7UIwmYafpFuhiiw6FRXLQ",reqType:"PUT",successHandler:createSuccess,errorHandler:createError,headers:{Accept:"application/json","Content-Type":"application/json;odata=verbose","x-sap-logontoken":BILaunchpadApp.getlogonToken()}};reqDispatcher.sendRequest(request);};com.sap.fioribi.modules.homepage.HomepageController.prototype.formatDateOnTile=function(id,currDate,refreshedDate){var diffDate=currDate.getTime()-refreshedDate.getTime();diffDays=diffDate/(1000*3600*24);var days=Math.floor(diffDays);if(days==0){var d1=Math.abs(currDate-refreshedDate)/3600000;var d2=Math.floor(d1);if(d2==0){var d3=(d1+"").split(".")[1];time=d3*60/100;time=Math.round(time);time=time+"";time=time.substring(0,2);if(time+""=="Na"){sap.ui.getCore().byId(id).mAggregations.tileContent[0].setFooter(BILaunchpadApp.localized("tileUpdated")+" "+BILaunchpadApp.localized("tileNow"));}else{sap.ui.getCore().byId(id).mAggregations.tileContent[0].setFooter(BILaunchpadApp.localized("tileUpdated")+" "+time+" "+BILaunchpadApp.localized("tileMins"));}}else{sap.ui.getCore().byId(id).mAggregations.tileContent[0].setFooter(BILaunchpadApp.localized("tileUpdated")+" "+d2+" "+BILaunchpadApp.localized("tileHours"));}}else{sap.ui.getCore().byId(id).mAggregations.tileContent[0].setFooter(BILaunchpadApp.localized("tileUpdated")+" "+days+" "+BILaunchpadApp.localized("tileDays"));if(days<1){sap.ui.getCore().byId(id).mAggregations.tileContent[0].setFooter(BILaunchpadApp.localized("tileUpdated")+" "+BILaunchpadApp.localized("tileNow"));}}};com.sap.fioribi.modules.homepage.HomepageController.prototype.formatHelper=function(number){if(number<1000){return number;}else{if(number==1000){return"1k";}else{if(number>1000){var q=parseInt(number/1000);var reminder=number%1000;if(reminder==0){return q+"k";}else{return q+"k+";}}}}};com.sap.fioribi.modules.homepage.HomepageController.prototype.formatCount=function(response){var revert=JSON.parse(JSON.stringify(response));var noOfProperty=Object.keys(response).length;var objectKeys=Object.keys(response);for(var i=0;i<noOfProperty;i++){switch((function(){return objectKeys[i].toLowerCase();})(objectKeys[i])){case"folderscount":revert.foldersCount=formatHelper(response[objectKeys[i]]);break;case"schedulescount":revert.schedulesCount=formatHelper(response[objectKeys[i]]);break;case"documentcount":revert.documentCount=formatHelper(response[objectKeys[i]]);break;case"categorycount":revert.categoryCount=formatHelper(response[objectKeys[i]]);break;case"unreadinboxitemscount":revert.unreadinboxitemsCount=formatHelper(response[objectKeys[i]]);break;case"recycleditemscount":revert.recycleditemsCount=formatHelper(response[objectKeys[i]]);break;}}function formatHelper(no){if(no<1000){return no;}else{if(no==1000){return"1k";}else{if(no>1000){var q=parseInt(no/1000);var reminder=no%1000;if(reminder==0){return q+"k";}else{return q+"k+";}}}}}return revert;};com.sap.fioribi.modules.homepage.HomepageController.prototype.redrawBackGroundShapes=function(){com.sap.fioribi.widgets.CanvasShapesManager.drawShapes();};com.sap.fioribi.modules.homepage.HomepageController.prototype.wait=function(ms){var start=new Date().getTime();var end=start;while(end<start+ms){end=new Date().getTime();}};com.sap.fioribi.modules.homepage.HomepageController.prototype.getCount=function(url){var $this=this;this.service=url;var updateTileInfo=function(response){var resp=$this.formatCount(response);if(JSON.stringify(resp).indexOf("documentCount")!=-1){sap.ui.getCore().getModel("myInfoCount").documentCountLastUpdated=response.currentServerTimeStamp;sap.ui.getCore().byId("Documents").mAggregations.tileContent[0].setFooter(BILaunchpadApp.localized("tileUpdated")+" "+BILaunchpadApp.localized("tileNow"));sap.ui.getCore().byId("Documents").mAggregations.tileContent[0].mAggregations.content.mAggregations.items[0].setProperty("value",resp.documentCount);sap.ui.getCore().byId("Documents").setState("Loaded");sap.ui.getCore().byId("Documents").rerender();sap.ui.getCore().setModel(resp.documentCount,"documentCount");}if(JSON.stringify(resp).indexOf("schedulesCount")!=-1){sap.ui.getCore().getModel("myInfoCount").scheduledInstancesCountLastUpdated=response.currentServerTimeStamp;sap.ui.getCore().byId("Schedules").mAggregations.tileContent[0].setFooter(BILaunchpadApp.localized("tileUpdated")+" "+BILaunchpadApp.localized("tileNow"));sap.ui.getCore().byId("Schedules").mAggregations.tileContent[0].mAggregations.content.mAggregations.items[0].setProperty("value",resp.schedulesCount);sap.ui.getCore().byId("Schedules").setState("Loaded");sap.ui.getCore().byId("Schedules").rerender();sap.ui.getCore().setModel(resp.schedulesCount,"schedulesCount");}if(JSON.stringify(resp).indexOf("categoryCount")!=-1){sap.ui.getCore().getModel("myInfoCount").categoryCountLastUpdated=response.currentServerTimeStamp;sap.ui.getCore().byId("Categories").mAggregations.tileContent[0].setFooter(BILaunchpadApp.localized("tileUpdated")+" "+BILaunchpadApp.localized("tileNow"));sap.ui.getCore().byId("Categories").mAggregations.tileContent[0].mAggregations.content.mAggregations.items[0].setProperty("value",resp.categoryCount);sap.ui.getCore().byId("Categories").setState("Loaded");sap.ui.getCore().byId("Categories").rerender();sap.ui.getCore().setModel(resp.categoryCount,"categoryCount");}if(JSON.stringify(resp).indexOf("unreadInboxItemsCount")!=-1){sap.ui.getCore().getModel("myInfoCount").inboxUnreadItemsCountLastUpdated=response.currentServerTimeStamp;sap.ui.getCore().byId("Inbox").mAggregations.tileContent[0].setFooter(BILaunchpadApp.localized("tileUpdated")+" "+BILaunchpadApp.localized("tileNow"));sap.ui.getCore().byId("Inbox").mAggregations.tileContent[0].mAggregations.content.mAggregations.items[0].setProperty("value",resp.unreadInboxItemsCount);sap.ui.getCore().byId("Inbox").setState("Loaded");sap.ui.getCore().byId("Inbox").rerender();sap.ui.getCore().setModel(resp.unreadInboxItemsCount,"unreadInboxItemsCount");}if(JSON.stringify(resp).indexOf("foldersCount")!=-1){sap.ui.getCore().getModel("myInfoCount").folderCountLastUpdated=response.currentServerTimeStamp;sap.ui.getCore().byId("Folders").mAggregations.tileContent[0].setFooter(BILaunchpadApp.localized("tileUpdated")+" "+BILaunchpadApp.localized("tileNow"));sap.ui.getCore().byId("Folders").mAggregations.tileContent[0].mAggregations.content.mAggregations.items[0].setProperty("value",resp.foldersCount);sap.ui.getCore().byId("Folders").setState("Loaded");sap.ui.getCore().byId("Folders").rerender();sap.ui.getCore().setModel(resp.foldersCount,"foldersCount");}if(JSON.stringify(resp).indexOf("recycledItemsCount")!=-1){sap.ui.getCore().getModel("myInfoCount").recycleBinItemsCountLastUpdated=response.currentServerTimeStamp;sap.ui.getCore().byId("RecycleBin").mAggregations.tileContent[0].setFooter(BILaunchpadApp.localized("tileUpdated")+" "+BILaunchpadApp.localized("tileNow"));sap.ui.getCore().byId("RecycleBin").mAggregations.tileContent[0].mAggregations.content.mAggregations.items[0].setProperty("value",resp.recycledItemsCount);sap.ui.getCore().byId("RecycleBin").setState("Loaded");sap.ui.getCore().byId("RecycleBin").rerender();sap.ui.getCore().setModel(resp.recycledItemsCount,"recycledItemsCount");}};var updateTileInfoError=function(response){if($this.service.indexOf("documentsCount")!=-1){sap.ui.getCore().byId("Documents").mAggregations.tileContent[0].setFooter(BILaunchpadApp.localized("tileNotRefresh"));}if($this.service.indexOf("scheduledInstancesCount")!=-1){sap.ui.getCore().byId("Schedules").mAggregations.tileContent[0].setFooter(BILaunchpadApp.localized("tileNotRefresh"));}if($this.service.indexOf("categoriesCount")!=-1){sap.ui.getCore().byId("Categories").mAggregations.tileContent[0].setFooter(BILaunchpadApp.localized("tileNotRefresh"));}if($this.service.indexOf("inboxUnredItemsCount")!=-1){sap.ui.getCore().byId("Inbox").mAggregations.tileContent[0].setFooter(BILaunchpadApp.localized("tileNotRefresh"));}if($this.service.indexOf("foldersCount")!=-1){sap.ui.getCore().byId("Folders").mAggregations.tileContent[0].setFooter(BILaunchpadApp.localized("tileNotRefresh"));}if($this.service.indexOf("recycleBinItemsCount")!=-1){sap.ui.getCore().byId("RecycleBin").mAggregations.tileContent[0].setFooter(BILaunchpadApp.localized("tileNotRefresh"));}var clsBtn=new sap.m.Button({text:BILaunchpadApp.localized("Error"),press:$.proxy(function(){errDialog.close();},this)});var errDialog=new sap.m.Dialog().addButton(clsBtn);errDialog.open();errDialog.setTitle(BILaunchpadApp.localized("Error"));BILaunchpadApp.oErrorHandler.showErrorMessage(xhr,errDialog);bError=true;};jQuery.sap.require("com.sap.fioribi.utils.RequestDispatcher");var uUrl=BILaunchpadApp.getWebServiceBaseURL()+"/internal/v1/"+url;var request={surl:uUrl,reqType:"GET",successHandler:updateTileInfo,errorHandler:updateTileInfoError,headers:{"x-SAP-logonToken":BILaunchpadApp.getlogonToken(),Accept:"application/json","Content-Type":"application/json;odata=verbose",}};var reqDispatcher=new RequestDispatcher();reqDispatcher.sendRequest(request);};com.sap.fioribi.modules.homepage.HomepageController.prototype.showBusyIndicator=function(iDuration,iDelay){sap.ui.core.BusyIndicator.show(iDelay);if(iDuration&&iDuration>0){if(this._sTimeoutId){jQuery.sap.clearDelayedCall(this._sTimeoutId);this._sTimeoutId=null;}this._sTimeoutId=jQuery.sap.delayedCall(iDuration,this,function(){this.hideBusyIndicator();});}};com.sap.fioribi.modules.homepage.HomepageController.prototype.hideBusyIndicator=function(){sap.ui.core.BusyIndicator.hide();};com.sap.fioribi.modules.homepage.HomepageController.prototype.setHeaderLabel=function(newTitle){this.getView().setHeaderTitle(newTitle);};com.sap.fioribi.modules.homepage.HomepageController.prototype.resetHeaderLabel=function(){this.setHeaderLabel(BILaunchpadApp.localized("bi_launchpad"));};com.sap.fioribi.modules.homepage.HomepageController.prototype.attachDragandDrop=function(oContainer){oContainer.addDragDropConfig(new sap.ui.core.dnd.DragInfo({sourceAggregation:"items"}));oContainer.addDragDropConfig(new sap.f.dnd.GridDropInfo({targetAggregation:"items",dropPosition:sap.ui.core.dnd.DropPosition.Between,dropLayout:sap.ui.core.dnd.DropLayout.Horizontal,drop:function(oInfo){var oDragged=oInfo.getParameter("draggedControl"),oDropped=oInfo.getParameter("droppedControl"),sInsertPosition=oInfo.getParameter("dropPosition"),iDragPosition=oContainer.indexOfItem(oDragged),iDropPosition=oContainer.indexOfItem(oDropped);if(oDragged.data("module")!==oDropped.data("module")){return;}oContainer.removeItem(oDragged);if(iDragPosition<iDropPosition){iDropPosition--;}if(sInsertPosition==="After"){iDropPosition++;}oContainer.insertItem(oDragged,iDropPosition);oContainer.focusItem(iDropPosition);}}));};com.sap.fioribi.modules.homepage.HomepageController.prototype.getPinnedDocuments=function(oModel){var reqDispatcher=new RequestDispatcher();var createError=function(xhr,ajaxOptions,thrownError){};var createSuccess=function(response){if(response!=""){var obj=oModel.getData();for(var i=0;i<response.entries.length;i++){var data={cuid:response.entries[i].cuid,title:response.entries[i].title,pageId:"",type:response.entries[i].type,id:response.entries[i].id,bpinned:true};obj.tableData.push(data);oModel.setData(obj);}}};var request={surl:BILaunchpadApp.getWebServiceBaseURL()+"/internal/v1/settings/userpreferences/pinneddocuments",reqType:"GET",successHandler:createSuccess,errorHandler:createError,headers:{Accept:"application/json","Content-Type":"application/json;odata=verbose","x-sap-logontoken":BILaunchpadApp.getlogonToken()}};reqDispatcher.sendRequest(request);};com.sap.fioribi.modules.homepage.HomepageController.prototype.fnPinReport=function(objData){var reqDispatcher=new RequestDispatcher();var createError=function(xhr,ajaxOptions,thrownError){};var createSuccess=function(response){};var request={surl:BILaunchpadApp.getWebServiceBaseURL()+"/internal/v1/settings/userpreferences/pinneddocuments",reqType:"POST",successHandler:createSuccess,errorHandler:createError,data:JSON.stringify(objData),headers:{Accept:"application/json","Content-Type":"application/json;odata=verbose","x-sap-logontoken":BILaunchpadApp.getlogonToken()}};reqDispatcher.sendRequest(request);};com.sap.fioribi.modules.homepage.HomepageController.prototype.fnUnPinReport=function(objData){var reqDispatcher=new RequestDispatcher();var createError=function(xhr,ajaxOptions,thrownError){};var createSuccess=function(response){};var request={surl:BILaunchpadApp.getWebServiceBaseURL()+"/internal/v1/settings/userpreferences/unpindocument",reqType:"POST",successHandler:createSuccess,errorHandler:createError,data:JSON.stringify(objData),headers:{Accept:"application/json","Content-Type":"application/json;odata=verbose","x-sap-logontoken":BILaunchpadApp.getlogonToken()}};reqDispatcher.sendRequest(request);};com.sap.fioribi.modules.homepage.HomepageController.prototype.getColumnNameAsPerPreferenceModel=function(columnName){if(columnName=="updated"){columnName="lastupdated";}if(columnName=="owner"){columnName="createdby";}if(columnName=="created"){columnName="createdon";}if(columnName=="lastRun"){columnName="lastrun";}if(columnName=="favorite"){columnName="myfavorites";}if(columnName=="kind"){columnName="type";}return columnName;};com.sap.fioribi.modules.homepage.HomepageController.prototype.getCountofUnpinnedOpenedDocuments=function(){var openedDocData=BILaunchpadApp.getOpenedDocumentsData();var unpinnedDocCount=0;for(var i=0;i<openedDocData.length;i++){if(!openedDocData[i].bpinned){unpinnedDocCount++;}}return unpinnedDocCount;};